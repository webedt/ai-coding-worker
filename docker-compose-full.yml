version: '3.8'

services:
  # GitHub Pull API - Clones/pulls repositories
  github-pull-api:
    build:
      context: ./github-pull-api
      dockerfile: Dockerfile
    container_name: github-pull-api
    ports:
      - "4000:4000"
    environment:
      - PORT=4000
      - WORKSPACE_DIR=/workspace
      - NODE_ENV=production
    volumes:
      # Shared workspace volume
      - workspace:/workspace
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - workflow-network

  # Claude Code API - Executes Claude Code commands
  claude-code-api:
    build:
      context: ./claude-code-api
      dockerfile: Dockerfile
    container_name: claude-code-api
    ports:
      - "3000:3000"
    environment:
      - PORT=3000
      - WORKSPACE_DIR=/workspace
      - NODE_ENV=production
      - CLAUDE_CODE_CREDENTIALS_JSON=${CLAUDE_CODE_CREDENTIALS_JSON}
    volumes:
      # Shared workspace volume
      - workspace:/workspace
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - workflow-network

  # Workflow API - Orchestrates the workflow
  workflow-api:
    build:
      context: ./workflow-api
      dockerfile: Dockerfile
    container_name: workflow-api
    ports:
      - "5000:5000"
    environment:
      - PORT=5000
      - GITHUB_PULL_API=http://github-pull-api:4000
      - CLAUDE_CODE_API=http://claude-code-api:3000
      - NODE_ENV=production
    depends_on:
      - github-pull-api
      - claude-code-api
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - workflow-network

volumes:
  workspace:
    driver: local

networks:
  workflow-network:
    driver: bridge
